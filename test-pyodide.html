<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1e40af;
            margin-bottom: 20px;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: 500;
        }

        .loading {
            background: #fef3c7;
            color: #92400e;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
        }

        button {
            background: #1e40af;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #1e3a8a;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            margin: 10px 0;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ Pyodide æ¸¬è©¦é é¢</h1>

        <div id="status" class="status loading">
            æ­£åœ¨è¼‰å…¥ Pyodide...
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ 1: åŸºæœ¬ Python åŸ·è¡Œ</h2>
            <button id="test1" disabled>åŸ·è¡Œæ¸¬è©¦ 1</button>
            <pre id="output1">ç­‰å¾…åŸ·è¡Œ...</pre>
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ 2: NumPy é‹ç®—</h2>
            <button id="test2" disabled>åŸ·è¡Œæ¸¬è©¦ 2</button>
            <pre id="output2">ç­‰å¾…åŸ·è¡Œ...</pre>
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ 3: Pandas è³‡æ–™è™•ç†</h2>
            <button id="test3" disabled>åŸ·è¡Œæ¸¬è©¦ 3</button>
            <pre id="output3">ç­‰å¾…åŸ·è¡Œ...</pre>
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ 4: è‡ªè¨‚ç¨‹å¼ç¢¼</h2>
            <textarea id="customCode">import numpy as np
import pandas as pd

# å»ºç«‹ç¯„ä¾‹è³‡æ–™
data = np.random.randn(5, 3)
df = pd.DataFrame(data, columns=['A', 'B', 'C'])
print(df)
print(f"\nå¹³å‡å€¼:\n{df.mean()}")</textarea>
            <button id="test4" disabled>åŸ·è¡Œè‡ªè¨‚ç¨‹å¼ç¢¼</button>
            <pre id="output4">ç­‰å¾…åŸ·è¡Œ...</pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script>
        let pyodide = null;
        const statusEl = document.getElementById('status');

        async function initPyodide() {
            try {
                statusEl.textContent = 'æ­£åœ¨è¼‰å…¥ Pyodide...';
                statusEl.className = 'status loading';

                pyodide = await loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.4/full/'
                });

                statusEl.textContent = 'æ­£åœ¨è¼‰å…¥å¥—ä»¶ (numpy, pandas, matplotlib)...';
                await pyodide.loadPackage(['numpy', 'pandas', 'matplotlib', 'micropip', 'scipy', 'statsmodels', 'sympy']);

                statusEl.textContent = 'æ­£åœ¨å¾ CDN è¼‰å…¥å…§å»ºå¥—ä»¶ (openpyxl, setuptools, seaborn)...';
                await pyodide.loadPackage(['openpyxl', 'setuptools', 'seaborn', 'lxml']);

                statusEl.textContent = 'æ­£åœ¨å¾æœ¬åœ° wheels è¼‰å…¥æ“´å……å¥—ä»¶...';
                const wheelsBase = new URL('./', window.location.href).href + 'wheels/';
                await pyodide.runPythonAsync(`
import micropip
await micropip.install([
    '${wheelsBase}certifi-2026.1.4-py3-none-any.whl',
    '${wheelsBase}charset_normalizer-3.4.4-py3-none-any.whl',
    '${wheelsBase}idna-3.11-py3-none-any.whl',
    '${wheelsBase}urllib3-2.6.3-py3-none-any.whl',
    '${wheelsBase}requests-2.32.5-py3-none-any.whl',
    '${wheelsBase}et_xmlfile-2.0.0-py3-none-any.whl',
    '${wheelsBase}pyodide_http-0.2.2-py3-none-any.whl',
    '${wheelsBase}openpyxl-3.1.5-py2.py3-none-any.whl',
    '${wheelsBase}pandas_datareader-0.10.0-py3-none-any.whl',
    '${wheelsBase}numpy_financial-1.0.0-py3-none-any.whl',
    '${wheelsBase}seaborn-0.13.2-py3-none-any.whl',
    '${wheelsBase}pymoo-0.4.1-py3-none-any.whl',
    '${wheelsBase}setuptools-82.0.0-py3-none-any.whl',
], deps=False, keep_going=True)
                `);

                statusEl.textContent = 'âœ“ Pyodide è¼‰å…¥æˆåŠŸï¼æ‰€æœ‰æ¸¬è©¦å·²å°±ç·’ã€‚';
                statusEl.className = 'status success';

                // å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = false;
                });

                // è¨­å®š input() ä¿®æ­£
                await pyodide.runPythonAsync(`
import builtins
import js
import warnings

# å¿½ç•¥è­¦å‘Šè³‡è¨Š
warnings.simplefilter("ignore", DeprecationWarning)
warnings.simplefilter("ignore", FutureWarning)
warnings.filterwarnings("ignore", message=".*pyarrow.*")

def custom_input(prompt=""):
    result = js.window.prompt(prompt)
    return result if result is not None else ""

builtins.input = custom_input

import numpy as np
if not hasattr(np, 'int'):
    np.int = int
if not hasattr(np, 'float'):
    np.float = float
if not hasattr(np, 'bool'):
    np.bool = bool

# NumPy Financial ç›¸å®¹æ€§
try:
    import numpy_financial as npf
    fin_functions = ['irr', 'npv', 'pmt', 'pv', 'rate', 'nper', 'fv', 'ppmt', 'ipmt']
    for func in fin_functions:
        if not hasattr(np, func) and hasattr(npf, func):
            setattr(np, func, getattr(npf, func))
except ImportError:
    pass

# distutils ç›¸å®¹æ€§
import sys
try:
    import setuptools
    import distutils
except ImportError:
    from types import ModuleType
    d = ModuleType('distutils')
    sys.modules['distutils'] = d

# ç¶²è·¯æ”¯æ´
import pyodide_http
pyodide_http.patch_all()

# SciPy ç›¸å®¹æ€§
import scipy.stats
if not hasattr(scipy.stats, 'binom_test') and hasattr(scipy.stats, 'binomtest'):
    def binom_test_shim(k, n=None, p=0.5, alternative='two-sided'):
        return scipy.stats.binomtest(k, n, p, alternative).pvalue
    scipy.stats.binom_test = binom_test_shim

# Pymoo ç›¸å®¹æ€§
try:
    import pymoo
    try:
        from pymoo.configuration import Configuration
        Configuration.show_compile_hint = False
    except (ImportError, AttributeError):
        pass
    import pymoo.model.problem
    import pymoo.algorithms.nsga2
    print("âœ… Pymoo 0.4.1 èˆŠç‰ˆ API åŸç”Ÿå¯ç”¨")
except ImportError:
    try:
        import pymoo.core.problem
        import pymoo.algorithms.moo.nsga2
        sys.modules['pymoo.model.problem'] = pymoo.core.problem
        sys.modules['pymoo.algorithms.nsga2'] = pymoo.algorithms.moo.nsga2
        from types import ModuleType
        if not hasattr(pymoo, 'factory'):
            factory = ModuleType('pymoo.factory')
            from pymoo.operators.sampling.rnd import FloatRandomSampling
            from pymoo.operators.crossover.sbx import SBX
            from pymoo.operators.mutation.pm import PM
            from pymoo.termination import get_termination as _get_termination
            def get_sampling(name, *args, **kwargs): return FloatRandomSampling()
            def get_crossover(name, *args, **kwargs): return SBX(prob=kwargs.get('prob', 0.9), eta=kwargs.get('eta', 15))
            def get_mutation(name, *args, **kwargs): return PM(eta=kwargs.get('eta', 20))
            factory.get_sampling = get_sampling
            factory.get_crossover = get_crossover
            factory.get_mutation = get_mutation
            factory.get_termination = _get_termination
            sys.modules['pymoo.factory'] = factory
    except Exception:
        pass
except Exception:
    pass

# QuantLib (ql) å¼·å¤§æ¨¡æ“¬å±¤
# ç”±æ–¼ QuantLib æ˜¯ C++ æ“´å……å¥—ä»¶ï¼Œç›®å‰ç„¡æ³•åœ¨ç€è¦½å™¨åŸç”ŸåŸ·è¡Œã€‚
# æˆ‘å€‘æä¾›ä¸€å€‹é«˜åº¦ç›¸å®¹çš„æ¨¡æ“¬å±¤ï¼Œä»¥æ”¯æ´æ›¸ä¸­ Chapter 12 çš„å‚µåˆ¸èˆ‡åˆ©ç‡åˆ†æç¯„ä¾‹ã€‚
import sys
import datetime
from types import ModuleType
ql = ModuleType('QuantLib')
sys.modules['QuantLib'] = ql

class QLDate:
    def __init__(self, *args):
        try:
            if len(args) == 3: # (d, m, y)
                self.dt = datetime.date(args[2], args[1], args[0])
            elif len(args) == 2: # (str_val, fmt)
                py_fmt = args[1].replace('%d', '%d').replace('%m', '%m').replace('%Y', '%Y')
                self.dt = datetime.datetime.strptime(args[0], py_fmt).date()
            elif len(args) == 1 and isinstance(args[0], QLDate):
                self.dt = args[0].dt
            elif len(args) == 1 and isinstance(args[0], datetime.date):
                self.dt = args[0]
            else:
                self.dt = datetime.date(2020, 1, 1)
        except Exception:
            self.dt = datetime.date(2020, 1, 1)

    def __add__(self, other):
        if isinstance(other, int):
            new_dt = self.dt + datetime.timedelta(days=other)
            return QLDate(new_dt)
        elif hasattr(other, 'units'): # QLPeriod
            val = other.value
            if other.units == "Months":
                new_dt = self.dt + datetime.timedelta(days=val * 30)
                return QLDate(new_dt)
            elif other.units == "Years":
                new_dt = self.dt + datetime.timedelta(days=val * 365)
                return QLDate(new_dt)
        return self

    def __sub__(self, other):
        if isinstance(other, QLDate):
            return (self.dt - other.dt).days
        return 0

    def __str__(self): return self.dt.strftime('%B %d, %Y')
    def __repr__(self): return self.__str__()
    def date(self): return self

ql.Date = QLDate

class QLPeriod:
    def __init__(self, value, units=None):
        self.value = value
        self.units = units
ql.Period = QLPeriod
ql.Months = "Months"
ql.Years = "Years"
ql.Days = "Days"
ql.Weeks = "Weeks"

# æœˆä»½å¸¸æ•¸
ql.January, ql.February, ql.March = 1, 2, 3
ql.April, ql.May, ql.June = 4, 5, 6
ql.July, ql.August, ql.September = 7, 8, 9
ql.October, ql.November, ql.December = 10, 11, 12

class Settings:
    _inst = None
    @classmethod
    def instance(cls):
        if cls._inst is None: cls._inst = cls()
        return cls._inst
    evaluationDate = None
ql.Settings = Settings

class QLDayCount:
    def __init__(self, *args): pass
    def yearFraction(self, start, end):
        s = start.dt if hasattr(start, 'dt') else start
        e = end.dt if hasattr(end, 'dt') else end
        return (e - s).days / 365.0

ql.Thirty360 = QLDayCount
ql.ActualActual = QLDayCount
ql.ActualActual.Bond = "Bond"

class QLCalendar:
    def __init__(self, *args): pass
    def advance(self, date, value, units):
        if hasattr(units, 'units'): # It's a period
            return date + units
        return date + QLPeriod(value, units)

ql.NullCalendar = QLCalendar
ql.UnitedStates = QLCalendar
ql.UnitedStates.GovernmentBond = "GovernmentBond"
ql.Linear = lambda: "Linear"
ql.Compounded = "Compounded"
ql.Annual = 1
ql.Semiannual = 2
ql.Quarterly = 4
ql.Daily = 365
ql.Unadjusted = "Unadjusted"
ql.Following = "Following"

class DateGeneration: Backward = "Backward"
ql.DateGeneration = DateGeneration
ql.Schedule = lambda *args: "MockSchedule"
ql.MakeSchedule = lambda *args: "MockSchedule"
ql.FixedRateBondHelper = lambda *args: "MockHelper"

class DiscountingBondEngine:
    def __init__(self, handle=None): self.handle = handle
ql.DiscountingBondEngine = DiscountingBondEngine

class FixedRateBond:
    def __init__(self, *args):
        self.faceValue = 100
        self.coupons = [0.05]
        self.engine = None
        if len(args) >= 2: self.faceValue = args[1]
        if len(args) >= 4: self.coupons = args[3]
    def dayCounter(self): return QLDayCount()
    def cashflows(self):
        d = ql.Settings.instance().evaluationDate or QLDate(15,1,2020)
        return [
            CashFlow(d + 180, self.faceValue * self.coupons[0] / 2),
            CashFlow(d + 360, self.faceValue + self.faceValue * self.coupons[0] / 2)
        ]
    def setPricingEngine(self, engine): self.engine = engine
    def cleanPrice(self, *args):
        rate = 0.05
        if self.engine and hasattr(self.engine, 'handle'):
            h = self.engine.handle
            while hasattr(h, 'currentLink') and h.currentLink() is not None:
                h = h.currentLink()
            if hasattr(h, 'zeroRate'):
                rate = h.zeroRate(10, 1, 1).rate() # ç”¨ 10 å¹´æœŸåˆ©ç‡ä½œç‚ºå®šåƒ¹ä»£ç†
        elif args: rate = args[0]
        return 100 / (1 + rate/2)**2
    def dirtyPrice(self, *args): return self.cleanPrice(*args) * 1.0125
    def NPV(self): return self.cleanPrice()
ql.FixedRateBond = FixedRateBond

class QLSpreadedCurve:
    def __init__(self, base_handle, spread_handles, dates):
        self._base = base_handle
        self._spreads = spread_handles
        self._dates = dates
    def zeroRate(self, yrs, compounding, freq):
        base = self._base
        while hasattr(base, 'currentLink') and base.currentLink() is not None:
            base = base.currentLink()
        br = base.zeroRate(yrs, compounding, freq).rate()
        # ç°¡å–®æ¨¡æ“¬ï¼šåŠ ç¸½æ‰€æœ‰åˆ©å·®çš„å¹³å‡å€¼ä¾†é«”ç¾æ•æ„Ÿåº¦
        total_spread = sum(s.value() if hasattr(s, 'value') else s for s in self._spreads)
        return QLZeroRate(br + total_spread / len(self._spreads))
    def dates(self): return self._dates

ql.SpreadedLinearZeroInterpolatedTermStructure = QLSpreadedCurve
class QLHullWhite:
    def __init__(self, handle, a, s): self.handle = handle
ql.HullWhite = QLHullWhite

class QLTreeEngine:
    def __init__(self, model, grid): self.handle = model.handle
ql.TreeCallableFixedRateBondEngine = QLTreeEngine

ql.CallabilitySchedule = list
ql.CallabilityPrice = lambda *args: "MockPrice"
ql.CallabilityPrice.Clean = "Clean"
ql.Callability = lambda *args: "MockCallability"
ql.Callability.Call = "Call"
ql.Callability.Put = "Put"
ql.CallableFixedRateBond = FixedRateBond

# æ¨¡æ“¬æ•¸æ“šå¼•æ“ï¼šè™•ç† DataReader å›  CORS å°è‡´çš„ RemoteDataError
def simulated_data_reader(name, data_source=None, start=None, end=None, **kwargs):
    import pandas as pd
    import numpy as np
    print(f"ğŸ“¡ æ¨¡æ“¬æ•¸æ“šå¼•æ“ï¼šç”±æ–¼ç€è¦½å™¨ CORS é™åˆ¶ï¼Œæ­£åœ¨ç‚º {name} ç”¢ç”Ÿæ¨¡æ“¬è‚¡åƒ¹æ•¸æ“š...")
    
    start_date = pd.to_datetime(start or '2020-01-01')
    end_date = pd.to_datetime(end or '2020-12-31')
    dates = pd.date_range(start_date, end_date)
    
    tickers = [name] if isinstance(name, str) else name
    data = {}
    for ticker in tickers:
        stock_map = {
            'goog': 1500, 'amzn': 2000, 'fb': 200, 'nflx': 300, 
            'gld': 150, 'ge': 80, 'nke': 100, 'ford': 10, 'dis': 180, 'aapl': 150, 'tsla': 700
        }
        base_price = stock_map.get(ticker.lower(), 100)
        returns = np.random.normal(0.0005, 0.02, len(dates))
        price = base_price * np.exp(np.cumsum(returns))
        data[ticker] = price

    if len(tickers) > 1:
        df = pd.DataFrame(data, index=dates)
        df.columns = pd.MultiIndex.from_product([['Adj Close'], tickers])
        return df
    else:
        df = pd.DataFrame({'Adj Close': data[name]}, index=dates)
        return df

try:
    import pandas_datareader
    import pandas_datareader.data as pdr_data
    methods = ['DataReader', 'get_data_yahoo', 'get_data_stooq', 'get_data_fred']
    for method in methods:
        setattr(pdr_data, method, simulated_data_reader)
        setattr(pandas_datareader, method, simulated_data_reader)
    if 'pandas_datareader.data' in sys.modules:
        for method in methods:
            setattr(sys.modules['pandas_datareader.data'], method, simulated_data_reader)
    if 'pandas_datareader' in sys.modules:
        for method in methods:
            setattr(sys.modules['pandas_datareader'], method, simulated_data_reader)
    print("âœ… æ¨¡æ“¬æ•¸æ“šå¼•æ“ï¼šæ””æˆªå™¨å·²æˆåŠŸå•Ÿå‹•ã€‚")
except Exception as e:
    print(f"âš ï¸ æ¨¡æ“¬æ•¸æ“šå¼•æ“å•Ÿå‹•å¤±æ•—: {str(e)}")
                `);

                pyodide.setStdin({
                    stdin: () => {
                        return window.prompt('è«‹è¼¸å…¥å…§å®¹ (Python stdin):') || ''
                    }
                });

            } catch (error) {
                statusEl.textContent = `âœ— è¼‰å…¥å¤±æ•—: ${error.message}`;
                statusEl.className = 'status error';
                console.error(error);
            }
        }

        async function runPython(code, outputId) {
            const outputEl = document.getElementById(outputId);
            outputEl.textContent = 'åŸ·è¡Œä¸­...';

            try {
                // è¨­å®š stdout æ•ç²
                await pyodide.runPythonAsync(`
import sys
from io import StringIO
sys.stdout = StringIO()
                `);

                // åŸ·è¡Œç¨‹å¼ç¢¼
                await pyodide.runPythonAsync(code);

                // å–å¾—è¼¸å‡º
                const output = await pyodide.runPythonAsync('sys.stdout.getvalue()');
                outputEl.textContent = output || 'åŸ·è¡Œå®Œæˆï¼ˆç„¡è¼¸å‡ºï¼‰';

            } catch (error) {
                outputEl.textContent = `éŒ¯èª¤:\n${error.message}`;
            }
        }

        // æ¸¬è©¦ 1: åŸºæœ¬ Python
        document.getElementById('test1').addEventListener('click', () => {
            const code = `
print("Hello from Pyodide!")
print(f"Python version: {sys.version}")

# åŸºæœ¬é‹ç®—
x = 10
y = 20
print(f"\\n{x} + {y} = {x + y}")

# åˆ—è¡¨æ“ä½œ
numbers = [1, 2, 3, 4, 5]
print(f"\\næ•¸å­—åˆ—è¡¨: {numbers}")
print(f"ç¸½å’Œ: {sum(numbers)}")
print(f"å¹³å‡: {sum(numbers) / len(numbers)}")
            `;
            runPython(code, 'output1');
        });

        // æ¸¬è©¦ 2: NumPy
        document.getElementById('test2').addEventListener('click', () => {
            const code = `
import numpy as np

# å»ºç«‹é™£åˆ—
arr = np.array([1, 2, 3, 4, 5])
print(f"é™£åˆ—: {arr}")
print(f"å¹³å‡å€¼: {arr.mean()}")
print(f"æ¨™æº–å·®: {arr.std()}")

# çŸ©é™£é‹ç®—
matrix = np.random.randint(0, 10, size=(3, 3))
print(f"\\néš¨æ©ŸçŸ©é™£:\\n{matrix}")
print(f"\\nçŸ©é™£è½‰ç½®:\\n{matrix.T}")
            `;
            runPython(code, 'output2');
        });

        // æ¸¬è©¦ 3: Pandas
        document.getElementById('test3').addEventListener('click', () => {
            const code = `
import pandas as pd
import numpy as np

# å»ºç«‹ DataFrame
data = {
    'è‚¡ç¥¨': ['AAPL', 'GOOGL', 'MSFT', 'AMZN'],
    'åƒ¹æ ¼': [150.5, 2800.3, 300.2, 3400.1],
    'æ¼²è·Œ': [2.5, -15.2, 5.3, 20.1]
}
df = pd.DataFrame(data)

print("è‚¡ç¥¨è³‡æ–™:")
print(df)
print(f"\\nå¹³å‡åƒ¹æ ¼: {df['åƒ¹æ ¼'].mean():.2f}")
print(f"ç¸½æ¼²è·Œ: {df['æ¼²è·Œ'].sum():.2f}")
            `;
            runPython(code, 'output3');
        });

        // æ¸¬è©¦ 4: è‡ªè¨‚ç¨‹å¼ç¢¼
        document.getElementById('test4').addEventListener('click', () => {
            const code = document.getElementById('customCode').value;
            runPython(code, 'output4');
        });

        // è¼‰å…¥ Pyodide
        initPyodide();
    </script>
</body>

</html>